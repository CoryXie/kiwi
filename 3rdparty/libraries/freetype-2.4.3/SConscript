#
# Copyright (C) 2010-2011 Alex Smith
#
# Permission to use, copy, modify, and/or distribute this software for any
# purpose with or without fee is hereby granted, provided that the above
# copyright notice and this permission notice appear in all copies.
#
# THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
# WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
# MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
# ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
# WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
# ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
# OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
#

# Notes about updating: ftconfig.h and ftmodule.h must be updated. This is done
# by doing a standard build using configure/make and copying the updated
# versions generated by the build. Note however that the copy of ftconfig.h
# generated by the build system has some platform-specific stuff for type sizes
# at the start, which must be reverted to the auto-detection in the default
# copy of the file.

Import('env')
import os

# Components and their sources.
components = {
	'base': [
		'ftsystem.c',
		'ftdebug.c',
		'ftinit.c',
		'ftbase.c',
		'ftbbox.c',
		'ftbdf.c',
		'ftbitmap.c',
		'ftcid.c',
		'ftfstype.c',
		'ftgasp.c',
		'ftglyph.c',
		'ftgxval.c',
		'ftlcdfil.c',
		'ftmm.c',
		'ftotval.c',
		'ftpatent.c',
		'ftpfr.c',
		'ftstroke.c',
		'ftsynth.c',
		'fttype1.c',
		'ftwinfnt.c',
		'ftxf86.c'
	],
	'truetype': ['truetype.c'],
	'type1': ['type1.c'],
	'cff': ['cff.c'],
	'cid': ['type1cid.c'],
	'pfr': ['pfr.c'],
	'type42': ['type42.c'],
	'winfonts': ['winfnt.c'],
	'pcf': ['pcf.c'],
	'bdf': ['bdf.c'],
	'sfnt': ['sfnt.c'],
	'autofit': ['autofit.c'],
	'pshinter': ['pshinter.c'],
	'raster': ['raster.c'],
	'smooth': ['smooth.c'],
	'cache': ['ftcache.c'],
	'gzip': ['ftgzip.c'],
	'lzw': ['ftlzw.c'],
	'psaux': ['psaux.c'],
	'psnames': ['psmodule.c'],
}

# Generate the source list.
sources = []
for (k, v) in components.items():
	for f in v:
		sources.append(File(os.path.join('src', k, f)))

# Build the library.
env.KiwiLibrary('freetype',
	sources = sources,
	libraries = ['z'],
	include_path = Dir('#3rdparty/libraries/freetype-2.4.3/include'),
	flags = {
		'CCFLAGS': filter(lambda f: f[0:2] != '-W', env['CCFLAGS']) + [
			'-Wall',
			'-Werror',
		],
		'CPPDEFINES': {
			'FT_CONFIG_OPTION_SYSTEM_ZLIB': None,
			'FT_CONFIG_CONFIG_H': '"<ftconfig.h>"',
			'FT2_BUILD_LIBRARY': None,
			'FT_CONFIG_MODULES_H': '"<ftmodule.h>"',
		},
		'CPPPATH': env['CPPPATH'] + [
			'builds/unix',
			'#3rdparty/libraries/freetype-2.4.3/include/freetype/config',
		],
	},
)
